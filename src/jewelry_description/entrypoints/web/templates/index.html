<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∫ Jewelry Cost Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .material-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .material-item:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd;
        }
        .material-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .material-badge {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .badge-metal { background-color: #ffc107; color: #000; }
        .badge-stone { background-color: #28a745; color: #fff; }
        .badge-material { background-color: #6c757d; color: #fff; }
        .selected-materials {
            max-height: 300px;
            overflow-y: auto;
        }
        .results-section {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }
        .price-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #0d6efd;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .copy-btn {
            position: relative;
        }
        .copy-success {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .copy-success.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">üè∫ Jewelry Cost Calculator</h1>
            </div>
        </div>
        
        <div class="row">
            <!-- Materials Selection Panel -->
            <div class="col-md-6">
                <!-- Material Search & Selection -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Materials</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAddMaterialModal()">+ Add Custom</button>
                    </div>
                    <div class="card-body">
                        <input type="text" class="form-control mb-3" id="materialSearch" 
                               placeholder="Search materials..." oninput="filterMaterials()">
                        <div id="materialList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Materials will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Selected Materials -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Selected Materials</h5>
                    </div>
                    <div class="card-body selected-materials" id="selectedMaterials">
                        <p class="text-muted text-center">No materials selected yet</p>
                    </div>
                </div>
                
                <!-- Project Details -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Project Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="jewelryType" class="form-label">Type:</label>
                                <select class="form-select" id="jewelryType" onchange="calculate()">
                                    <option value="–∫–æ–ª—å—Ü–æ">–ö–æ–ª—å—Ü–æ (Ring)</option>
                                    <option value="–∫—É–ª–æ–Ω">–ö—É–ª–æ–Ω (Pendant)</option>
                                    <option value="–±—Ä–∞—Å–ª–µ—Ç">–ë—Ä–∞—Å–ª–µ—Ç (Bracelet)</option>
                                    <option value="—Å–µ—Ä—å–≥–∏">–°–µ—Ä—å–≥–∏ (Earrings)</option>
                                    <option value="–∫–∞—Ñ—Ñ">–ö–∞—Ñ—Ñ (Ear cuff)</option>
                                    <option value="–±—Ä–æ—à—å">–ë—Ä–æ—à—å (Brooch)</option>
                                    <option value="—á–æ–∫–µ—Ä">–ß–æ–∫–µ—Ä (Choker)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="hours" class="form-label">Hours:</label>
                                <input type="number" class="form-control" id="hours" value="2" 
                                       step="0.5" min="0.1" onchange="calculate()">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="rate" class="form-label">Rate (‚Ç∏/hr):</label>
                                <input type="number" class="form-control" id="rate" value="2000" 
                                       min="100" onchange="calculate()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div class="col-md-6">
                <div class="results-section" id="resultsSection">
                    <h5 class="mb-3">üí∞ Cost Calculation</h5>
                    <div id="results">
                        <div class="text-center text-muted py-5">
                            <p>Select materials and enter project details to see calculations</p>
                            <div class="spinner-border d-none" id="loadingSpinner" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h5 class="mb-3">üìù Instagram Description</h5>
                    <div id="descriptionSection">
                        <textarea id="description" class="form-control" rows="6" readonly 
                                  placeholder="Description will appear here..."></textarea>
                        <div class="mt-3 d-none" id="copyButtons">
                            <button class="btn btn-primary copy-btn" onclick="copyDescription()">
                                üìã Copy Description
                                <div class="copy-success" id="copySuccess1">Copied!</div>
                            </button>
                            <button class="btn btn-outline-primary copy-btn ms-2" onclick="copyAll()">
                                üìã Copy All Results
                                <div class="copy-success" id="copySuccess2">Copied!</div>
                            </button>
                            <button class="btn btn-outline-secondary copy-btn ms-2" onclick="selectAllText()">
                                üìù Select All Text
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Material Modal -->
    <div class="modal fade" id="addMaterialModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Custom Material</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMaterialForm">
                        <div class="mb-3">
                            <label for="newMaterialName" class="form-label">Material Name:</label>
                            <input type="text" class="form-control" id="newMaterialName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newMaterialPrice" class="form-label">Price per Unit:</label>
                            <input type="number" class="form-control" id="newMaterialPrice" step="0.01" min="0.01" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="newMaterialUnit" class="form-label">Unit:</label>
                                <select class="form-select" id="newMaterialUnit">
                                    <option value="–≥">–≥ (gram)</option>
                                    <option value="—à—Ç">—à—Ç (piece)</option>
                                    <option value="—Å–º">—Å–º (cm)</option>
                                    <option value="–º">–º (meter)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="newMaterialCategory" class="form-label">Category:</label>
                                <select class="form-select" id="newMaterialCategory">
                                    <option value="material">Material</option>
                                    <option value="metal">Metal</option>
                                    <option value="stone">Stone</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomMaterial()">Add Material</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let materials = [];
        let selectedMaterials = [];
        let addMaterialModal;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            addMaterialModal = new bootstrap.Modal(document.getElementById('addMaterialModal'));
            loadMaterials();
        });

        // Load materials from API
        async function loadMaterials() {
            try {
                const response = await axios.get('/api/materials');
                materials = response.data.materials;
                displayMaterials();
            } catch (error) {
                console.error('Error loading materials:', error);
                document.getElementById('materialList').innerHTML = '<p class="text-danger">Error loading materials</p>';
            }
        }

        // Display materials in the list
        function displayMaterials(filteredMaterials = null) {
            const materialList = document.getElementById('materialList');
            const materialsToShow = filteredMaterials || materials;
            
            if (materialsToShow.length === 0) {
                materialList.innerHTML = '<p class="text-muted">No materials found</p>';
                return;
            }
            
            materialList.innerHTML = materialsToShow.map(material => `
                <div class="material-item" onclick="selectMaterial('${material.name}', ${material.price}, '${material.unit}', '${material.category}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${material.name}</strong>
                            <span class="material-badge badge-${material.category}">${material.category}</span>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold">${material.price} ‚Ç∏</span>
                            <br>
                            <small class="text-muted">per ${material.unit}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filter materials based on search
        function filterMaterials() {
            const searchTerm = document.getElementById('materialSearch').value.toLowerCase();
            const filtered = materials.filter(material => 
                material.name.toLowerCase().includes(searchTerm) ||
                material.category.toLowerCase().includes(searchTerm)
            );
            displayMaterials(filtered);
        }

        // Select a material
        function selectMaterial(name, price, unit, category) {
            console.log('Selecting material:', { name, price, unit, category });
            
            const quantity = prompt(`Enter quantity for "${name}" (in ${unit}):`);
            if (!quantity || isNaN(quantity) || quantity <= 0) {
                console.log('Invalid quantity entered:', quantity);
                return;
            }
            
            const material = {
                name: name,
                price: price,
                unit: unit,
                quantity: parseFloat(quantity),
                category: category
            };
            
            console.log('Adding material:', material);
            
            // Check if material already selected
            const existingIndex = selectedMaterials.findIndex(m => m.name === name);
            if (existingIndex >= 0) {
                selectedMaterials[existingIndex].quantity += material.quantity;
                console.log('Updated existing material quantity');
            } else {
                selectedMaterials.push(material);
                console.log('Added new material to selection');
            }
            
            displaySelectedMaterials();
            calculate();
        }

        // Display selected materials
        function displaySelectedMaterials() {
            const container = document.getElementById('selectedMaterials');
            
            if (selectedMaterials.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No materials selected yet</p>';
                return;
            }
            
            container.innerHTML = selectedMaterials.map((material, index) => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded">
                    <div>
                        <strong>${material.name}</strong><br>
                        <small>${material.quantity} ${material.unit} √ó ${material.price} ‚Ç∏ = ${(material.quantity * material.price).toFixed(2)} ‚Ç∏</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeMaterial(${index})">√ó</button>
                </div>
            `).join('');
        }

        // Remove selected material
        function removeMaterial(index) {
            selectedMaterials.splice(index, 1);
            displaySelectedMaterials();
            calculate();
        }

        // Calculate costs
        async function calculate() {
            console.log('Calculate function called');
            
            if (selectedMaterials.length === 0) {
                document.getElementById('results').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <p>Select materials and enter project details to see calculations</p>
                    </div>
                `;
                document.getElementById('description').value = '';
                document.getElementById('copyButtons').classList.add('d-none');
                return;
            }
            
            const hours = parseFloat(document.getElementById('hours').value);
            const rate = parseFloat(document.getElementById('rate').value);
            const jewelryType = document.getElementById('jewelryType').value;
            
            console.log('Calculation inputs:', { hours, rate, jewelryType, materials: selectedMaterials });
            
            if (!hours || !rate || hours <= 0 || rate <= 0) {
                console.warn('Invalid hours or rate:', { hours, rate });
                return;
            }
            
            // Show loading
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultsSection = document.getElementById('resultsSection');
            
            if (loadingSpinner) loadingSpinner.classList.remove('d-none');
            if (resultsSection) resultsSection.classList.add('loading');
            
            try {
                console.log('Sending request to /api/calculate');
                const response = await axios.post('/api/calculate', {
                    materials: selectedMaterials,
                    hours: hours,
                    hourly_rate: rate,
                    jewelry_type: jewelryType
                });
                
                console.log('Received response:', response.data);
                const results = response.data;
                displayResults(results);
                document.getElementById('copyButtons').classList.remove('d-none');
                
            } catch (error) {
                console.error('Error calculating:', error);
                const errorMsg = error.response?.data?.detail || error.message || 'Unknown error occurred';
                document.getElementById('results').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h6>Calculation Error</h6>
                        <p>${errorMsg}</p>
                        <small>Check browser console for more details.</small>
                    </div>
                `;
            } finally {
                // Hide loading
                if (loadingSpinner) loadingSpinner.classList.add('d-none');
                if (resultsSection) resultsSection.classList.remove('loading');
            }
        }

        // Display calculation results
        function displayResults(results) {
            document.getElementById('results').innerHTML = `
                <div class="price-item">
                    <h4 class="text-primary mb-3">Total Cost: ${results.total_cost.toFixed(0)} ‚Ç∏</h4>
                    
                    <h6 class="mb-3">Recommended Prices:</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center p-2 bg-warning bg-opacity-25 rounded">
                                <strong>Minimal (√ó2)</strong><br>
                                ${results.recommended_prices.minimal.toFixed(0)} ‚Ç∏
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-2 bg-success bg-opacity-25 rounded">
                                <strong>Comfortable (√ó2.5)</strong><br>
                                ${results.recommended_prices.comfortable.toFixed(0)} ‚Ç∏
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-2 bg-info bg-opacity-25 rounded">
                                <strong>Premium (√ó3)</strong><br>
                                ${results.recommended_prices.premium.toFixed(0)} ‚Ç∏
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">${results.price_comment}</small>
                    </div>
                </div>
            `;
            
            document.getElementById('description').value = results.description;
        }

        // Show add material modal
        function showAddMaterialModal() {
            document.getElementById('addMaterialForm').reset();
            addMaterialModal.show();
        }

        // Add custom material
        async function addCustomMaterial() {
            const name = document.getElementById('newMaterialName').value.trim();
            const price = parseFloat(document.getElementById('newMaterialPrice').value);
            const unit = document.getElementById('newMaterialUnit').value;
            const category = document.getElementById('newMaterialCategory').value;
            
            if (!name || !price || price <= 0) {
                alert('Please fill in all required fields with valid values');
                return;
            }
            
            try {
                const response = await axios.post('/api/materials', {
                    name: name,
                    price: price,
                    unit: unit,
                    category: category
                });
                
                if (response.data.status === 'success') {
                    addMaterialModal.hide();
                    loadMaterials(); // Reload materials list
                    alert(`Material "${name}" added successfully!`);
                }
            } catch (error) {
                console.error('Error adding material:', error);
                alert('Error adding material. Please try again.');
            }
        }

        // Copy description to clipboard
        async function copyDescription() {
            const description = document.getElementById('description').value;
            
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    // Modern clipboard API
                    await navigator.clipboard.writeText(description);
                    showCopySuccess('copySuccess1');
                } else {
                    // Fallback for older browsers or non-HTTPS
                    const textArea = document.createElement('textarea');
                    textArea.value = description;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showCopySuccess('copySuccess1');
                }
            } catch (error) {
                console.error('Copy failed:', error);
                alert('Copy failed. Please select and copy the text manually.');
            }
        }

        // Copy all results to clipboard
        async function copyAll() {
            try {
                const results = document.querySelector('#results .price-item');
                const description = document.getElementById('description').value;
                
                if (!results) {
                    alert('No results to copy yet. Please calculate first.');
                    return;
                }
                
                let text = results.innerText + '\n\n' + description;
                
                if (navigator.clipboard && window.isSecureContext) {
                    // Modern clipboard API
                    await navigator.clipboard.writeText(text);
                    showCopySuccess('copySuccess2');
                } else {
                    // Fallback for older browsers or non-HTTPS
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showCopySuccess('copySuccess2');
                }
            } catch (error) {
                console.error('Copy failed:', error);
                alert('Copy failed. Please select and copy the text manually.');
            }
        }

        // Show copy success message
        function showCopySuccess(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('show');
                setTimeout(() => {
                    element.classList.remove('show');
                }, 2000);
            }
        }

        // Fallback function to select all text for manual copying
        function selectAllText() {
            const description = document.getElementById('description');
            if (description) {
                description.select();
                description.setSelectionRange(0, description.value.length);
                alert('Text selected. Press Ctrl+C (or Cmd+C on Mac) to copy.');
            }
        }

        // Add global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });

        // Add unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>
</body>
</html>